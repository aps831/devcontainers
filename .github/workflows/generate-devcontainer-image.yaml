name: Generate Dev Container Image
on:
  workflow_call:
    inputs:
      devcontainername:
        required: true
        type: string
permissions:
  contents: read
  packages: write
jobs:
  devcontainer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8 # pin@v3.1.0

      - uses: actions/setup-node@969bd2663942d722d85b6a8626225850c2f7be4b # pin@v3.5.0
        with:
          node-version: "16"

      - run: |
          set -e

          FOLDER_WITH_DOT_DEVCONTAINER=${{ inputs.devcontainername }}
          IMAGE_NAME="devcontainers/${{ inputs.devcontainername }}"
          IMAGE_REPOSITORY="$(echo "ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:latest" | tr '[:upper:]' '[:lower:]')"

          # Enable buildkit, set output to plain text for logging
          export DOCKER_BUILDKIT=1
          export BUILDKIT_PROGRESS=plain

          # Login
          echo "${{ github.token }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

          # Do the build - update
          npm install -g "@vscode/dev-container-cli"
          devcontainer build --image-name "${IMAGE_REPOSITORY}" "${FOLDER_WITH_DOT_DEVCONTAINER}"

          # Push image to GitHub Container Registry
          docker push "${IMAGE_REPOSITORY}"
